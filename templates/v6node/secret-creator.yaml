apiVersion: batch/v1
kind: Job
metadata:
  name: create-capsule-node-secret
  namespace: {{ .Values.defaultNamespace }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    spec:
      serviceAccountName: secret-manager
      restartPolicy: OnFailure
      containers:
        - name: secret-creator
          image: bitnami/kubectl:latest
          command:
            - /bin/sh
            - -c
            - |
              set -e

              echo "Fetching omop-secret..."
              SECRET=$(kubectl get secret omop-secret -n {{ .Values.omop.namespace }} -o json)
              USER=$(echo "$SECRET" | jq -r '.data.POSTGRES_USER' | base64 -d)
              PASSWORD=$(echo "$SECRET" | jq -r '.data.POSTGRES_PASSWORD' | base64 -d)

              DATABASE_URI="jdbc:postgresql://{{ .Values.omop.service.name }}.{{ .Values.omop.namespace }}.svc.cluster.local:{{ .Values.omop.service.port }}/{{ .Values.omop.db.name }}"

              echo "Creating capsule-node secret..."
              kubectl create secret generic idea4rc-capsule-node-secrets \
                --namespace {{ .Values.defaultNamespace }} \
                --from-literal=DATABASE_LABELS="omop" \
                --from-literal=DATABASE_OMOP_USER=${USER} \
                --from-literal=DATABASE_OMOP_PASSWORD=${PASSWORD} \
                --from-literal=DATABASE_OMOP_TYPE="other" \
                --from-literal=DATABASE_OMOP_URI=${DATABASE_URI} \
                --from-literal=V6_API_KEY="{{ .Values.v6node.node.apiKey }}" \
                --from-literal=V6_NODE_NAME="{{ .Values.v6node.node.name }}" \
                --from-literal=KEYCLOAK_CLIENT={{ .Values.v6node.node.keycloak.client }} \
                --from-literal=KEYCLOAK_CLIENT_SECRET="{{ .Values.v6node.node.keycloak.clientSecret }}" \
                --dry-run=client -o yaml | kubectl apply -f -
