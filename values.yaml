# This is the default namespace for the capsule. Please note that this variable *DOES NOT SET* the namespace of the individual components. You'll have to change/override that for each component that you whish to deploy those in a specific namespace.
defaultNamespace: datamesh

# This is the IP/Domain Name used to expose the capsule, should be overridden at install/upgrade time with the desired IP using --set capsulePublicHost=(MY CAPSULE IP)
capsulePublicHost: "127.0.0.1"

# ISTIO configuration is defined here
istio:
  ideaGwHosts: "*"
  mtlsMode: STRICT
  istioInjection: enabled
  tls:
    commonName: "127.0.0.1"

# Enable/disable Auth configuration and configure multiple roles for authentication.
auth:
  enable: False
  jwtIssuer: "https://keycloak.idea.lst.tfo.upm.es/realms/IDEA4RC"
  jwksUri: "https://keycloak.idea.lst.tfo.upm.es/realms/IDEA4RC/protocol/openid-connect/certs"
  policies:
    medic:
      policy_name: require-jwt-medic
      methods: "POST"
      roles: "Medic"
      namespace: datamesh
    patient:
      policy_name: require-jwt
      methods: "GET"
      roles: "Patient"
      namespace: datamesh

# Hostpath-based custom storage class for k8s. This enables persistency for the various DB instances of the capsule across upgrades. This is useful in certain cases where we want to avoid data loss, for eg.: across restarts of the guest machine or when restarting services. This can lead to data inconsistecy and other issues and it's not the inteded way of using the capsule, which should be recreated every time the source dataset changes or when upgrading. Please note that deleting the capsule using "helm delete" will delete the volumes, too.
idea4rcStorageClass:
  name: idea4rc-hostpath
  enabled: true
  isDefault: "true"
  provisioner: microk8s.io/hostpath
  reclaimpolicy: Retain
  volumebindingmode: Immediate

## FHIR data server configuration
fhirDataServer:
  service:
    name: fhir-data-svc
  server:
    name: fhir-data-server
    namespace: datamesh
    image:
      registry: ghcr.io
      repository: idea4rc/fhir-data-server
      tag: "1.0"
      pull_policy: IfNotPresent
    configmap_name: fhir-data-application-cm
  db:
    name: fhir-data-postgres-db
    image: postgres:13-alpine
    dbName: idea4rc
    service:
      name: fhir-data-postgres-db
      port: 5432
    pvc:
      name: fhir-dataserver-pg-pv-claim
    secret:
      name: fhir-dataserver-pg-secret
  virtualService:
    enabled: false

## FHIR dictionary server configuration
fhirDictionary:
  service:
    name: fhir-dictionary-svc
  server:
    name: fhir-dictionary-server
    namespace: datamesh
    image:
      registry: ghcr.io
      repository: idea4rc/fhir-data-server
      tag: "1.0"
      pull_policy: IfNotPresent
    configmap_name: fhir-dictionary-application-cm
  db:
    name: fhir-dictionary-postgres-db
    image: postgres:13-alpine
    dbName: idea4rc
    service:
      name: fhir-dictionary-postgres-db
      port: 5432
    pvc:
      name: fhir-dictionary-pg-pv-claim
    secret:
      name: fhir-dictionary-pg-secret
  virtualService:
    enabled: false

## Data Extraction
dataextractor:
  name: dataextractor
  namespace: datamesh
  server:
    image: "ghcr.io/idea4rc/idea4rc_ai_dataextractionjobs:1.0"
  db:
    name: dataextract-postgres-db
    image: postgres:16.3-bullseye
    dbName: mad
  fhir:
    namespace: datamesh
    service:
      name: fhir-data-svc
  virtualService:
    enabled: true

## OMOP Database
omop:
  namespace: datamesh
  app: omop-postgres
  cdm:
    name: omop-cdm-deployment
    image: ghcr.io/idea4rc/omop-deploy@sha256:2b873c3c450193349d91957c66d5ced35d13cd271ebc660facca9af7134449b4
  vocab:
    name: populate-db-job
    ttl: 120
    image: ghcr.io/idea4rc/omop-vocab-uploader@sha256:9c38c4a3e95c08933c63f1e3afe9cd41f300352a223c7fed04db87fd0d078900
  db:
    name: omopdb
    schema: omopcdm_synthetic
    result_schema: results_synthetic
  vocabJob: true

## Capsule Workbench
workbench:
  name: capsule-workbench
  namespace: datamesh
  image: ghcr.io/idea4rc/capsule-workbench@sha256:5de9ca7610fd4497b26ebef08a82e6b42545303ffc81fa4dccc5bbfcfa4a9f86

## Apache Reverse Proxy for those WebApps that have issues with 
## ISTIO's reverse proxy functionality
revproxy:
  namespace: datamesh
  app: revproxy
  server:
    name: revproxy
    replicas: 1
    image: httpd:2.4.61
    port: 80
  service:
    name: revproxy-svc
    port: 80
    targetPort: 80
    type: ClusterIP

## OHDSI API, used by Vantage6 to retrieve data from the capsule
ohdsi-api:
  ohdsi:
    name: ohdsi-api
    namespace: datamesh
    image: harbor2.vantage6.ai/infrastructure/ohdsi-api:0.0.8
    virtualService:
      enabled: true
  
  ## Celery Worker & relative DB
  celery:
    namespace: datamesh
    db:
      name: celery-db
      database: ohdsi
      image: postgres:16.3-bullseye
    worker:
      name: celery-worker
      image: harbor2.vantage6.ai/infrastructure/ohdsi-api:0.0.8

## IdeaDB
ideadb:
  namespace: datamesh
  server:
    name: ideadb
    image: bitnami/mariadb:11.4.2
    imagePullPolicy: IfNotPresent
    config: ""
    persistence:
      enabled: false
      storageClass: generic
      accessMode: ReadWriteOnce
      size: 8Gi
  db:
    name: ideadb
    port: 3306
  service:
    name: ideadb-svc
    port: 3306
    targetPort: mysql
